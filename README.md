# 图片管理工具 (Image Manager)

![Version](https://img.shields.io/badge/version-2.2-blue.svg)
![Python](https://img.shields.io/badge/python-3.10+-green.svg)
![License](https://img.shields.io/badge/license-MIT-orange.svg)

一个轻量级、高性能的本地图片管理工具，基于 Python Flask 构建。专为摄影师和视觉创作者设计，提供流畅的瀑布流浏览体验，支持 RAW 格式预览、HEIC 自动转码、审美提升模式等高级功能。

## ✨ 核心特性

### 🚀 高效浏览与管理
- **瀑布流布局**：采用 Masonry 布局，支持海量图片流畅加载与浏览。
- **多标签独立空间**：
  - **独立DOM管理**：全部、JPG、已标记、RAW 标签各自保持独立的DOM空间。
  - **无缝切换**：切换标签时无需重新渲染，保持浏览位置和滚动状态。
  - **智能渲染队列**：未查看的标签加入渲染队列，切换到该标签时再渲染。
- **渐进式渲染优化**：
  - **快速首屏**：初始只渲染12个图片，首屏显示速度提升约1.67倍。
  - **智能懒加载**：滚动到70%时开始加载，每次加载8个图片，避免内容堆积。
  - **流畅体验**：使用 `requestAnimationFrame` 同步浏览器渲染，新内容出现在屏幕下方。
- **批量处理模式**：
  - **批量选择**：支持多选图片，全选/取消选择，实时显示选择数量。
  - **批量标记**：一键标记/取消标记多个图片。
  - **批量删除**：支持批量删除，移动到回收站或永久删除。
- **格式全兼容**：
  - **通用格式**：完美支持 JPG, PNG, WEBP, GIF, BMP 等。
  - **RAW 支持**：内置 `rawpy`，支持预览 ARW, CR2, NEF, DNG 等专业相机格式。
  - **HEIC 自动转码**：自动识别并转换 Apple HEIC/HIF 格式为 JPG，确保全平台兼容性。
- **智能整理**：
  - **一键分类**：按文件格式自动归档整理。
  - **快速标记**：星标精选照片，支持独立筛选查看。
  - **安全删除**：内置回收站机制，支持误删一键恢复。
- **系统托盘支持**：
  - **后台运行**：程序启动后自动常驻系统托盘，不占用任务栏。
  - **快速访问**：通过托盘菜单一键打开浏览器界面或彻底退出程序。

### 🎨 审美提升模式 (Aesthetic Mode)
打破文件夹限制，提供沉浸式的灵感探索体验。
- **随机漫游**：递归扫描指定根目录，将所有作品随机混排展示。
- **元数据识别**：智能解析 `.\作者\作品名\` 目录结构，展示作者与作品信息。
- **关联探索**：点击作者或作品名，即可反向筛选该系列的所有相关作品。
- **独立视图**：拥有独立的 UI 容器与状态记忆，不干扰常规文件管理。
- **多层级筛选**：支持在筛选结果上进行二次筛选，保留筛选历史。
- **渐进式渲染**：与整理审阅模式一致的渲染优化，确保流畅浏览体验。

### �️ 系统托盘 (System Tray)
为了提供更原生的应用体验，程序内置了系统托盘功能：
- **自动隐藏**：启动后程序将自动最小化到系统托盘（任务栏右下角）。
- **右键菜单**：
  - **打开浏览器**：重新打开图片管理主界面。
  - **退出**：彻底关闭后端服务。
- **状态常驻**：关闭浏览器窗口不会停止服务，确保后台任务（如转码、扫描）持续运行。

### �🛠️ 技术亮点
- **完全本地化**：所有依赖（Viewer.js, FontAwesome 等）均内置，无需联网，零外部请求。
- **性能优化**：
  - **渐进式渲染**：初始渲染少量内容，滚动时动态加载，内存占用低。
  - **智能渲染队列**：只渲染当前查看的标签，其他标签延迟渲染。
  - **DOM复用**：标签切换时复用DOM，避免重复创建和销毁。
  - **requestAnimationFrame**：同步浏览器渲染周期，确保流畅动画。
- **状态管理**：
  - **独立状态空间**：每个标签维护独立的滚动位置、渲染状态。
  - **智能更新**：删除/恢复文件时只更新当前标签，其他标签加入渲染队列。
  - **RAW显示优化**：先判断是否有RAW文件，再决定是否需要重新渲染。
- **便携运行**：支持打包为单文件 EXE，无需配置环境，即插即用。

## 📦 快速开始

### 方式一：直接运行 (Windows)
1. 下载最新发布的 `dist/ImageManager.exe`。
2. 双击运行，程序将自动启动并打开默认浏览器。
3. 在顶部导航栏选择需要管理的图片文件夹即可开始使用。

### 方式二：源码运行
适用于开发者或非 Windows 环境。

1. **环境准备**
   确保已安装 Python 3.10+。

2. **安装依赖**
   ```bash
   pip install flask pillow rawpy pillow-heif pillow-avif-plugin pystray
   ```

3. **启动服务**
   - **Windows**: 双击 `start.bat` 即可自动安装依赖并启动。
   - **通用**: 运行 `python image_manager.py`。

4. **浏览器访问**

   打开浏览器访问

   ```
   http://localhost:5000/
   ```

   服务成功加载出现如下页面

   ![image-20251225171636400](README.assets/image-20251225171636400.png)

   点击右下角进入审美提升模式

   ![image-20251225171539734](README.assets/image-20251225171539734.png)

   ​		

## 🔨 构建指南

如果你想自己打包 EXE 文件：

1. 安装 PyInstaller：
   ```bash
   pip install pyinstaller
   ```
2. 运行构建脚本 (Windows)：
   ```bat
   .\build_release.bat
   ```
3. 构建产物将生成在 `dist/` 目录下。

## 📂 项目结构

```text
.
├── image_manager.py      # 核心后端逻辑 (Flask)
├── aesthetic_mode.py     # 审美模式扫描模块
├── templates/            # 前端模板
│   └── index.html        # 单页应用入口
├── static/               # 静态资源
│   └── vendor/           # 本地化第三方库
└── start.bat             # Windows 快速启动脚本
```

## 📝 更新日志

### v2.2 (2025-12-27)

#### ✨ 新增功能
- **批量处理模式**：
  - 支持批量选择图片（点击图片或复选框）
  - 批量标记/取消标记多个图片
  - 批量删除图片（支持移动到回收站或永久删除）
  - 全选/取消选择功能
  - 实时显示选择数量
- **多标签独立DOM空间**：
  - 全部、JPG、已标记、RAW 标签各自保持独立的DOM空间
  - 切换标签时无需重新渲染，保持浏览位置和滚动状态
  - 参考审美模式的实现思路，确保稳定性和性能

#### ⚡ 性能优化
- **渐进式渲染优化**：
  - 初始只渲染30个图片（从20个减少），首屏显示速度提升约1.67倍
  - 滚动到70%时开始懒加载（从固定像素改为百分比）
  - 每次懒加载8个图片（从10个减少），避免内容堆积
  - 使用 `requestAnimationFrame` 同步浏览器渲染周期
  - 新内容出现在屏幕下方，不会影响当前视图
- **智能渲染队列**：
  - 删除/恢复文件时只更新当前标签，其他标签加入渲染队列
  - RAW显示开关时先判断是否有RAW文件，再决定是否需要重新渲染
  - 切换标签时如果未渲染，才进行渲染，已渲染的标签直接显示
- **状态管理优化**：
  - 每个标签独立保存滚动位置
  - 切换标签时自动恢复滚动位置
  - 优化异步初始化逻辑，避免状态不一致

#### 🐛 问题修复
- 修复多次切换标签后无法正确渲染的问题
- 修复RAW格式导致死机的问题（添加防抖和重试限制）
- 修复删除/恢复文件时重新渲染所有标签的问题
- 修复开启RAW显示时重新渲染所有标签的问题

### v2.1 (2025-12-25)
- **New**: 新增系统托盘支持，支持后台运行与快速菜单操作。
- **New**: 新增 AVIF 格式支持。
- **Imp**: 完善 Windows 环境下的启动脚本 `start.bat`。

### v2.0
- **New**: 新增"审美提升模式"，支持随机浏览与元数据反查。
- **New**: 新增 HEIC/HIF 格式自动转码 JPG 功能。
- **Imp**: 优化缩略图生成逻辑，支持更多色彩模式与 EXIF 旋转。
- **Imp**: 引入分批次懒加载，显著提升大图库浏览性能。
- **Fix**: 修复了部分特殊字符路径导致的预览失败问题。

### v1.0
- 基础图片浏览、整理、标记与回收站功能。
- RAW 格式预览支持。

## 📄 许可证

本项目采用 [MIT License](LICENSE) 开源。
